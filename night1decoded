local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Window = Rayfield:CreateWindow({
   Name = "Infiltration Ult | 24h Fix",
   LoadingTitle = "Syncing 24h Clock...",
   ConfigurationSaving = {Enabled = true, FolderName = "InfUlt", FileName = "Cfg"},
   KeySystem = false,
})

local player = game.Players.LocalPlayer
local workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local Lighting = game:GetService("Lighting")

local function notify(t, c) Rayfield:Notify({Title=t, Content=c, Duration=3, Image=4483362458}) end
local function SafeLoad(p, n) local o = p:FindFirstChild(n); if not o then o = p:WaitForChild(n, 1) end; return o end

local shack = workspace:WaitForChild("Shack", 5)
local generator = shack and shack:WaitForChild("Generator", 5)
local fuel = generator and generator:WaitForChild("Fuel", 5)
local gameState = ReplicatedStorage:WaitForChild("GameState", 5)

if not shack or not generator or not gameState then notify("Error", "Objects missing") end

local mods = {
    Bloodmoon = SafeLoad(gameState, "Bloodmoon"),
    Blizzard = SafeLoad(gameState, "Blizzard"),
    Zombies = SafeLoad(gameState, "Zombies"),
    Thunderstorm = SafeLoad(gameState, "Thunderstorm"),
    Event = SafeLoad(gameState, "Event")
}
local fireFuel = SafeLoad(gameState, "FireFuel")
local woodPile = SafeLoad(workspace, "WoodPile")
local firePlace = SafeLoad(workspace, "FirePlace")

-- ==================== TOGGLE VARIABLES ====================
local RefuelToggle, FuelESPToggle, LightsToggle
local FireToggle, FireESPToggle = nil, nil 

-- ==================== SAFETY GLOBALS ====================
_G.ActionInProgress = false 
_G.Refueling = false
_G.Anchor = nil 
_G.LastMutantDespawn = 0

workspace.ChildRemoved:Connect(function(child)
    if child.Name == "Mutant" then
        _G.LastMutantDespawn = tick()
    end
end)

-- ==================== UTILS & COORDINATES ====================
local RoomCoordinates = {
    ["Entrance"] = Vector3.new(-4.87, 7.8, -36.31), 
    ["LivingRoom"] = Vector3.new(-22.82, 7.79, -52.76), 
    ["BottomCorridor"] = Vector3.new(-23.02, 7.79, -81.82), 
    ["Ladder"] = Vector3.new(-1.38, 7.79, -61.91), 
    ["TopCorridor"] = Vector3.new(-9.17, 23.79, -74.37), 
    ["Bedroom"] = Vector3.new(-15.19, 23.79, -74.88), 
    ["TopCorridor2"] = Vector3.new(-27.39, 23.79, -41.8), 
    ["Bathroom"] = Vector3.new(-27.76, 23.79, -46.76),
    ["WoodPile"] = Vector3.new(-30.2, 4.2, -114.0),
    ["FirePlace"] = Vector3.new(-44.5, 7.9, -61.9),
    ["JerryCan"] = Vector3.new(-76.875, 4.675, -133.212),
    ["BedSkip"] = Vector3.new(-43.1, 23.8, -77.4) -- Safe Spot
}

local function GetGroundedCFrame(v) return CFrame.new(v) end

local function InstantTP(cf)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    player.Character.HumanoidRootPart.CFrame = cf
end

local function ForceReturn(targetCF)
    if not player.Character then return end
    local hrp = player.Character.HumanoidRootPart
    
    for i = 1, 10 do
        hrp.Velocity = Vector3.new(0,0,0)
        hrp.CFrame = targetCF
        task.wait(0.05)
        if (hrp.Position - targetCF.Position).Magnitude < 5 then
            return 
        end
    end
    hrp.CFrame = targetCF 
end

local function EnableNoclip(bool)
    local NoclipConnection
    if bool then
        NoclipConnection = RunService.Stepped:Connect(function()
            if player.Character then
                for _, p in pairs(player.Character:GetDescendants()) do
                    if p:IsA("BasePart") and p.CanCollide then p.CanCollide = false end
                end
            end
        end)
        return NoclipConnection
    end
end

local function FlightMove(targetCFrame)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart
    local tween = TweenService:Create(hrp, TweenInfo.new((hrp.Position - targetCFrame.Position).Magnitude / 55, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
    local nc = EnableNoclip(true)
    tween:Play()
    tween.Completed:Wait()
    if nc then nc:Disconnect() end
end

-- ==================== 1. INFO TAB ====================
local InfoTab = Window:CreateTab("Info", 4483362458) 
InfoTab:CreateSection("Modifiers")
local function createStatusLabel(n, b)
    local a = b and b.Value==true
    local c = a and "#00FF00" or "#555555"
    local t = a and "ACTIVE" or "INACTIVE"
    InfoTab:CreateParagraph({Title = n, Content = string.format("<font color='%s'>%s</font>", c, t)})
end
createStatusLabel("Bloodmoon", mods.Bloodmoon)
createStatusLabel("Blizzard", mods.Blizzard)
createStatusLabel("Zombies", mods.Zombies)

InfoTab:CreateSection("Utils")
InfoTab:CreateButton({Name = "Reset / Unstuck", Callback = function() 
    _G.ActionInProgress = false; _G.Refueling = false; _G.Anchor = nil
    if player.Character then InstantTP(CFrame.new(RoomCoordinates["Entrance"])) end
    notify("System", "Reset.") 
end})

-- ==================== 2. NIGHT 1 TAB ====================
local NightTab = Window:CreateTab("Night 1", 4483362458)   
local FuelSection = NightTab:CreateSection("Fuel")
local autoConn = nil

local function WaitForSafety()
    if workspace:FindFirstChild("Mutant") then
        notify("Auto Refuel", "Mutant Active. Holding...")
        repeat task.wait(0.5) until not workspace:FindFirstChild("Mutant")
        task.wait(0.5) 
        return true
    end

    local timeSince = tick() - _G.LastMutantDespawn
    if timeSince > 18 then
        notify("Auto Refuel", "Risk Zone ("..math.floor(timeSince).."s). Waiting.")
        repeat task.wait(0.5) until workspace:FindFirstChild("Mutant") 
        repeat task.wait(0.5) until not workspace:FindFirstChild("Mutant") 
        _G.LastMutantDespawn = tick()
        task.wait(0.5) 
    end
end

local function executeRefuel(isManual)
    if isManual then _G.ActionInProgress = false; _G.Refueling = false end
    if _G.Refueling or _G.ActionInProgress then if isManual then notify("System", "Busy.") end; return end
    
    -- [[ ENDGAME CHECK ]] --
    -- If time > 05:10 (5.16) AND time < 06:00 (6.0) AND Fuel > 60%
    if Lighting.ClockTime >= 5.16 and Lighting.ClockTime < 6 and fuel.Value > 60 then
        notify("Auto Refuel", "Endgame (5:10+). Skipping.")
        return
    end
    
    if not isManual then WaitForSafety() end

    _G.Refueling = true; _G.ActionInProgress = true
    if player.Character then _G.Anchor = player.Character.HumanoidRootPart.CFrame end
    
    local s, e = pcall(function()
        local can = shack:FindFirstChild("JerryCan")
        if not can then notify("Error", "No Can!"); return end
        
        InstantTP(CFrame.new(RoomCoordinates["JerryCan"]))
        task.wait(0.1)
        
        if can:FindFirstChild("ClickDetector") then fireclickdetector(can.ClickDetector) end
        task.wait(0.4)
        
        if generator:FindFirstChild("ClickDetector") then fireclickdetector(generator.ClickDetector) end
        task.wait(0.5)
    end)

    if not s then notify("Error", "Crash: "..tostring(e)) end
    
    if _G.Anchor then ForceReturn(_G.Anchor) else ForceReturn(CFrame.new(RoomCoordinates["Entrance"])) end
    _G.Anchor = nil
    _G.Refueling = false; _G.ActionInProgress = false
    
    if s then notify("SUCCESS", "Refueled Gen.") end
end

RefuelToggle = NightTab:CreateToggle({
    Name = "Auto Refuel (40%)", 
    CurrentValue = false, 
    Flag = "AutoRefuel", 
    Callback = function(on)
        if on then 
            notify("Auto Refuel", "ON.")
            if autoConn then autoConn:Disconnect() end
            autoConn = fuel:GetPropertyChangedSignal("Value"):Connect(function() 
                if fuel.Value <= 40 and not _G.ActionInProgress and not _G.Refueling then 
                    task.spawn(function() executeRefuel(false) end) 
                end 
            end)
        else 
            notify("Auto Refuel", "OFF.")
            if autoConn then autoConn:Disconnect() end 
        end
    end
})

NightTab:CreateButton({Name = "Refuel Manually", Callback = function() task.spawn(function() executeRefuel(true) end) end})

FuelESPToggle = NightTab:CreateToggle({
    Name = "Fuel ESP", 
    CurrentValue = false, 
    Flag = "FuelESP", 
    Callback = function(v)
        if v then
            notify("Fuel ESP", "Enabled.")
            local b = Instance.new("BillboardGui", CoreGui); b.Adornee = generator:FindFirstChildWhichIsA("BasePart"); b.Size = UDim2.new(0,200,0,50); b.AlwaysOnTop = true; b.StudsOffset=Vector3.new(0,4,0)
            local t = Instance.new("TextLabel", b); t.Size = UDim2.new(1,0,1,0); t.BackgroundTransparency = 1; 
            t.TextColor3 = Color3.new(0,1,1); t.Font = Enum.Font.FredokaOne; t.TextSize = 22
            t.Text = "Fuel: "..fuel.Value.."%"; fuel.Changed:Connect(function() t.Text = "Fuel: "..fuel.Value.."%" end); _G.FuelBill = b
        else
            notify("Fuel ESP", "Disabled.")
            if _G.FuelBill then _G.FuelBill:Destroy() end
        end
    end
})
NightTab:CreateParagraph({Title = "Usage", Content = "Auto refuels generator or manually. Displays count in real-time."})

local LightsSection = NightTab:CreateSection("Lights")
local LCon = nil
LightsToggle = NightTab:CreateToggle({
    Name = "Auto Lights", 
    CurrentValue = false, 
    Flag = "AutoLights", 
    Callback = function(on)
        if on then
            notify("Auto Lights", "ON.")
            local function trap(m)
                task.wait(1.5)
                local wins = workspace:FindFirstChild("Windows")
                if wins and m:FindFirstChild("HumanoidRootPart") then
                    local close, dist = nil, 9999
                    for _,w in pairs(wins:GetChildren()) do
                        local p = w.PrimaryPart or w:FindFirstChildWhichIsA("BasePart")
                        if p and (m.HumanoidRootPart.Position - p.Position).Magnitude < dist then dist=(m.HumanoidRootPart.Position-p.Position).Magnitude; close=w end
                    end
                    if close and close:FindFirstChild("RoomName") then
                        while _G.ActionInProgress do task.wait(0.1) end; _G.ActionInProgress = true
                        local rn = close.RoomName.Value
                        if RoomCoordinates[rn] then
                            local start = player.Character.HumanoidRootPart.CFrame
                            FlightMove(GetGroundedCFrame(RoomCoordinates[rn]))
                            task.wait(0.7) 
                            for _,l in pairs(workspace.Lights:GetChildren()) do
                                if l.Status.RoomName.Value == rn then 
                                    fireclickdetector(l.Switch.Detector.ClickDetector)
                                    notify("SUCCESS", "Flashed Successfully.")
                                    task.wait(1)
                                    fireclickdetector(l.Switch.Detector.ClickDetector)
                                end
                            end
                            FlightMove(start)
                        end
                        _G.ActionInProgress = false
                    end
                end
            end
            if workspace:FindFirstChild("Mutant") then task.spawn(function() trap(workspace.Mutant) end) end
            LCon = workspace.ChildAdded:Connect(function(c) if c.Name=="Mutant" then task.wait(0.5); trap(c) end end)
        else
            notify("Auto Lights", "OFF.")
            if LCon then LCon:Disconnect() end
        end
    end
})
NightTab:CreateParagraph({Title = "Usage", Content = "Flashes lights when Mutant peeks (0.7s delay)."})

-- ==================== 3. BLIZZARD TAB ====================
if mods.Blizzard and mods.Blizzard.Value then
    local BzTab = Window:CreateTab("Blizzard", 4483362458); local fCon = nil
    
    local function restock()
        if _G.ActionInProgress or workspace:FindFirstChild("Mutant") then return end
        WaitForSafety()
        _G.ActionInProgress = true
        if player.Character then _G.Anchor = player.Character.HumanoidRootPart.CFrame end
        local s, e = pcall(function()
            if player.Character then
                InstantTP(GetGroundedCFrame(RoomCoordinates["WoodPile"])); 
                task.wait(0.3)
                if woodPile.Detector:FindFirstChild("ClickDetector") then fireclickdetector(woodPile.Detector.ClickDetector) end
                task.wait(0.5)
                InstantTP(CFrame.new(RoomCoordinates["FirePlace"])); 
                task.wait(0.4)
            end
        end)
        
        if _G.Anchor then ForceReturn(_G.Anchor) else ForceReturn(CFrame.new(RoomCoordinates["Entrance"])) end
        _G.Anchor = nil
        _G.ActionInProgress = false
        if s then notify("SUCCESS", "Refueled Fireplace.") end
    end
    
    FireToggle = BzTab:CreateToggle({
        Name = "Auto Fireplace", 
        Callback = function(on) 
            if on then 
                notify("Auto Fireplace", "ON.")
                if fCon then fCon:Disconnect() end
                fCon=fireFuel.Changed:Connect(function(v) 
                    if v<=50 and not _G.ActionInProgress and not _G.Refueling then 
                        task.spawn(restock) 
                    end 
                end) 
            else 
                notify("Auto Fireplace", "OFF.")
                if fCon then fCon:Disconnect() end 
            end 
        end
    })
    
    FireESPToggle = BzTab:CreateToggle({
        Name = "Fire ESP", 
        Callback = function(v)
            if v then
                notify("Fireplace ESP", "Enabled.")
                local b = Instance.new("BillboardGui", CoreGui); b.Adornee = firePlace; b.Size = UDim2.new(0,200,0,50); b.AlwaysOnTop = true; b.StudsOffset=Vector3.new(0,2,0)
                local t = Instance.new("TextLabel", b); t.Size = UDim2.new(1,0,1,0); t.BackgroundTransparency = 1; 
                t.TextColor3 = Color3.new(1,0.5,0); t.Font = Enum.Font.FredokaOne; t.TextSize = 22
                t.Text = "Fire: "..fireFuel.Value.."%"; fireFuel.Changed:Connect(function() t.Text = "Fire: "..fireFuel.Value.."%" end); _G.FireBill = b
            else
                notify("Fireplace ESP", "Disabled.")
                if _G.FireBill then _G.FireBill:Destroy() end
            end
        end
    })
    
    BzTab:CreateButton({Name = "Restock Manually", Callback = function() task.spawn(restock) end})
    BzTab:CreateParagraph({Title = "Usage", Content = "Refuels fire automatically (Instant TP)."})
end

-- ==================== 4. TESTING TAB ====================
local TestingTab = Window:CreateTab("Testing", 4483362458)

TestingTab:CreateToggle({
    Name = "Enable ALL (Master Switch)",
    CurrentValue = false,
    Callback = function(on)
        notify("SYSTEM", on and "Enabled." or "Disabled.")
        if RefuelToggle then RefuelToggle:Set(on) end
        if LightsToggle then LightsToggle:Set(on) end
        if FuelESPToggle then FuelESPToggle:Set(on) end
        if FireToggle then FireToggle:Set(on) end
        if FireESPToggle then FireESPToggle:Set(on) end
    end
})

local MutantLog = {}
local MutantCount = 0
local LastRealTime = tick()
local TestConnection = nil
local LogDisplay = TestingTab:CreateParagraph({Title = "Spawn History", Content = "Waiting for data..."})

local function TrackMutant()
    LastRealTime = tick() 
    TestConnection = workspace.ChildAdded:Connect(function(child)
        if child.Name == "Mutant" then
            MutantCount = MutantCount + 1
            local gameTime = Lighting.TimeOfDay 
            local interval = math.floor(tick() - LastRealTime)
            LastRealTime = tick()
            local newRow = string.format("[%s] Spawn #%d | Interval: %ds", gameTime, MutantCount, interval)
            table.insert(MutantLog, 1, newRow)
            LogDisplay:Set({Title = "Spawn History (" .. MutantCount .. ")", Content = table.concat(MutantLog, "\n")})
        end
    end)
end

TestingTab:CreateToggle({
    Name = "Test Mutant Spawn", 
    Callback = function(en) 
        if en then 
            notify("Test Mutant Spawn", "Tracking Enabled.")
            TrackMutant() 
        else 
            notify("Test Mutant Spawn", "Tracking Disabled.")
            if TestConnection then TestConnection:Disconnect() end 
        end 
    end
})
TestingTab:CreateButton({Name = "Clear Logs", Callback = function() MutantLog={}; MutantCount=0; LogDisplay:Set({Title="History", Content="Cleared."}) end})

-- ==================== PASSIVE FEATURES (Run Last) ====================
task.spawn(function()
    -- 1. CLOCK
    local pGui = player:WaitForChild("PlayerGui", 5)
    local dialogue = pGui and pGui:WaitForChild("DialogueUI", 5)
    if dialogue then
        local timerLabel = dialogue:WaitForChild("EventTimer", 5)
        if timerLabel then
            timerLabel.Visible = true 
            RunService.RenderStepped:Connect(function()
                timerLabel.Text = string.sub(Lighting.TimeOfDay, 1, 5) 
            end)
        end
    end
end)

-- 2. BED SKIP (PM Time 16:45)
task.spawn(function()
    local bedProcessed = false
    while task.wait(1) do
        local t = Lighting.ClockTime
        
        -- Trigger at 16:45 (16.75)
        if t >= 16.75 and t < 18 and not bedProcessed then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                -- Silent Lock
                _G.ActionInProgress = true 
                _G.Refueling = true 
                
                -- Teleport
                player.Character.HumanoidRootPart.CFrame = CFrame.new(RoomCoordinates["BedSkip"])
                
                -- Wait for 17:00 (17.0)
                repeat task.wait(0.5) until Lighting.ClockTime >= 17.0
                
                -- Click Bed
                local bed = workspace:FindFirstChild("BedSkip")
                if bed and bed:FindFirstChild("ClickDetector") then
                    fireclickdetector(bed.ClickDetector)
                end
                
                bedProcessed = true
            end
        end
        -- Reset flag next day
        if t < 10 then bedProcessed = false end
    end
end)
