local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Window = Rayfield:CreateWindow({
   Name = "Infiltration Engine | Checkpoints",
   LoadingTitle = "Setting Checkpoints...",
   LoadingSubtitle = "by Gemini",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "InfiltrationUltimate",
      FileName = "CheckpointConfig"
   },
   KeySystem = false,
})

-- ==================== 1. SERVICES & GLOBALS ====================
local player = game.Players.LocalPlayer
local workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

local function notify(title, content)
    Rayfield:Notify({Title = title, Content = content, Duration = 3, Image = 4483362458})
end

local function SafeLoad(parent, name)
    local obj = parent:FindFirstChild(name)
    if not obj then obj = parent:WaitForChild(name, 1) end
    return obj
end

-- ==================== 2. CRITICAL OBJECTS ====================
local shack = workspace:WaitForChild("Shack", 5)
local generator = shack and shack:WaitForChild("Generator", 5)
local fuel = generator and generator:WaitForChild("Fuel", 5)
local gameState = ReplicatedStorage:WaitForChild("GameState", 5)

-- MODIFIERS & VALUES
local mods = {
    Bloodmoon = SafeLoad(gameState, "Bloodmoon"),
    Blizzard = SafeLoad(gameState, "Blizzard"),
    Zombies = SafeLoad(gameState, "Zombies"),
    Thunderstorm = SafeLoad(gameState, "Thunderstrom") or SafeLoad(gameState, "Thunderstorm"),
    Event = SafeLoad(gameState, "Event")
}

local fireFuel = SafeLoad(gameState, "FireFuel")
local woodPile = SafeLoad(workspace, "WoodPile")
local firePlace = SafeLoad(workspace, "FirePlace")

if not shack or not generator or not gameState then 
    notify("WARNING", "Some game objects are missing.") 
end

-- ==================== 3. MENU TABS ====================
local InfoTab = Window:CreateTab("Info", 4483362458) 
local NightTab = Window:CreateTab("Night 1", 4483362458)   
local ToolsTab = Window:CreateTab("Tools", 4483362458) 

-- INFO TAB LOGIC
InfoTab:CreateSection("Active Modifiers")
local function createStatusLabel(name, boolObj)
    local isActive = boolObj and boolObj.Value == true
    local color = isActive and "#00FF00" or "#555555"
    local statusText = isActive and "ACTIVE!" or "INACTIVE"
    InfoTab:CreateParagraph({Title = name, Content = string.format("<font color='%s'>%s</font>", color, statusText)})
    return isActive
end
createStatusLabel("Bloodmoon", mods.Bloodmoon)
local isBlizzardActive = createStatusLabel("Blizzard", mods.Blizzard)
createStatusLabel("Graves (Zombies)", mods.Zombies)
createStatusLabel("Thunderstorm", mods.Thunderstorm)
createStatusLabel("Party (Event)", mods.Event)

-- ==================== 4. MOVEMENT LOGIC ====================
local ActionInProgress = false 
local CurrentTween = nil 
local NoclipConnection = nil

local RoomCoordinates = {
    ["Entrance"] = Vector3.new(-4.87, 7.8, -36.31), 
    ["LivingRoom"] = Vector3.new(-22.82, 7.79, -52.76), 
    ["BottomCorridor"] = Vector3.new(-23.02, 7.79, -81.82), 
    ["Ladder"] = Vector3.new(-1.38, 7.79, -61.91), 
    ["TopCorridor"] = Vector3.new(-9.17, 23.79, -74.37), 
    ["Bedroom"] = Vector3.new(-15.19, 23.79, -74.88), 
    ["TopCorridor2"] = Vector3.new(-27.39, 23.79, -41.8), 
    ["Bathroom"] = Vector3.new(-27.76, 23.79, -46.76),
    ["WoodPile"] = Vector3.new(-30.2, 4.2, -114.0),
    ["FirePlace"] = Vector3.new(-44.5, 7.9, -61.9),
    ["JerryCan"] = Vector3.new(-76.875, 4.675, -133.212)
}

local function GetGroundedCFrame(targetVector)
    local char = player.Character
    if not char or not char:FindFirstChild("Humanoid") then return CFrame.new(targetVector) end
    return CFrame.new(targetVector) 
end

-- A. INSTANT TELEPORT
local function InstantTP(targetCFrame)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart
    hrp.Velocity = Vector3.new(0,0,0)
    hrp.AssemblyLinearVelocity = Vector3.new(0,0,0)
    hrp.CFrame = targetCFrame
end

-- B. FLIGHT MOVE (For Lights)
local function FlightMove(targetCFrame)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart
    local tweenInfo = TweenInfo.new((hrp.Position - targetCFrame.Position).Magnitude / 55, Enum.EasingStyle.Linear) 
    CurrentTween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    CurrentTween:Play()
    CurrentTween.Completed:Wait()
end

-- EVACUATION SYSTEM
local function EmergencyEvac()
    if CurrentTween then CurrentTween:Cancel(); CurrentTween = nil end
    notify("CHECKPOINT", "Mutant Detected! Pausing...")
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        InstantTP(CFrame.new(RoomCoordinates["BottomCorridor"]))
    end
end

-- [[ NEW: CHECKPOINT SYSTEM ]] --
-- Replaces SmartWait. Instead of quitting, it waits and goes back.
local function EnsureSafePosition(targetCFrame, stepName)
    InstantTP(targetCFrame) -- Go to destination
    
    local timePassed = 0
    local requiredTime = 0.3 -- How long we need to stay safe
    
    while timePassed < requiredTime do
        if workspace:FindFirstChild("Mutant") then
            -- 1. DANGER DETECTED
            EmergencyEvac()
            
            -- 2. WAIT UNTIL SAFE
            repeat task.wait(1) until not workspace:FindFirstChild("Mutant")
            
            -- 3. RESUME (LOAD CHECKPOINT)
            notify("RESUME", "Resuming: " .. stepName)
            InstantTP(targetCFrame) 
            timePassed = 0 -- Reset timer to ensure safety
        else
            -- SAFE
            task.wait(0.05)
            timePassed = timePassed + 0.05
        end
    end
    return true
end

-- ==================== 5. REFUEL SYSTEM (CHECKPOINT) ====================
local FuelSection = NightTab:CreateSection("Fuel")
local refueling = false
local autoConn = nil

local function executeRefuel(isManual)
    if isManual then ActionInProgress = false; refueling = false end 
    if refueling or ActionInProgress then 
        if isManual then notify("BUSY", "Script is busy.") end
        return 
    end
    
    -- Manual check before starting
    if not isManual and workspace:FindFirstChild("Mutant") then notify("WAIT", "Mutant present."); return end

    refueling = true
    ActionInProgress = true
    
    local success, err = pcall(function()
        local can = shack:FindFirstChild("JerryCan")
        if not can then notify("ERROR", "No Jerry Can Found!"); return end
        
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local startPos = player.Character.HumanoidRootPart.CFrame
            notify("ACTION", "Fetching Gas...")
            
            -- CHECKPOINT 1: Go to Can
            EnsureSafePosition(CFrame.new(RoomCoordinates["JerryCan"]), "Fetch Gas")
            
            -- Pick up Can
            if can:FindFirstChild("ClickDetector") then 
                fireclickdetector(can.ClickDetector) 
            end
            
            -- CHECKPOINT 2: Stay at Can / Go to Gen
            -- We verify we are still safe before clicking Generator
            EnsureSafePosition(CFrame.new(RoomCoordinates["JerryCan"]), "Fill Generator")
            
            if generator:FindFirstChild("ClickDetector") then
                fireclickdetector(generator.ClickDetector)
                notify("SUCCESS", "Refueled.")
            end
            
            -- Wait for action to finish
            task.wait(0.2)

            -- CHECKPOINT 3: Return
            -- If mutant spawned right as we finished, we evac, then return to start pos later
            EnsureSafePosition(startPos, "Return Home")
            notify("DONE", "Returned.")
        end
    end)

    if not success then notify("ERROR", "Refuel Error: " .. tostring(err)) end
    refueling = false
    ActionInProgress = false
end

NightTab:CreateToggle({
   Name = "Auto Refuel (at 40%)",
   CurrentValue = false,
   Flag = "AutoRefuel",
   Callback = function(on)
        if on then
            notify("SYSTEM", "Auto Refuel ON (<= 40%).") 
            autoConn = fuel:GetPropertyChangedSignal("Value"):Connect(function()
                -- UPDATED THRESHOLD: 40
                if fuel.Value <= 40 then task.spawn(function() executeRefuel(false) end) end
            end)
        else
            notify("SYSTEM", "Auto Refuel OFF.") 
            if autoConn then autoConn:Disconnect() end
        end
   end,
})

NightTab:CreateParagraph({Title = "Usage", Content = "Uses Checkpoints. Hides if Mutant appears, then resumes."})
NightTab:CreateButton({Name = "Refuel Manually", Callback = function() task.spawn(function() executeRefuel(true) end) end})

NightTab:CreateToggle({
   Name = "Fuel ESP",
   CurrentValue = false,
   Flag = "FuelESP",
   Callback = function(v)
        if v then
            notify("SYSTEM", "Fuel ESP ON.") 
            local bill = Instance.new("BillboardGui", CoreGui)
            bill.Adornee = generator:FindFirstChildWhichIsA("BasePart"); bill.Size = UDim2.new(0,260,0,60); bill.StudsOffset = Vector3.new(0,4,0); bill.AlwaysOnTop = true
            local txt = Instance.new("TextLabel", bill); txt.Size = UDim2.new(1,0,1,0); txt.BackgroundTransparency = 1; txt.TextColor3 = Color3.fromRGB(0,255,255); txt.TextStrokeTransparency = 0; txt.Font = Enum.Font.GothamBold; txt.TextSize = 20
            txt.Text = "Fuel: "..fuel.Value.."%"; fuel.Changed:Connect(function() txt.Text = "Fuel: "..fuel.Value.."%" end)
            _G.FuelBill = bill
        else
            notify("SYSTEM", "Fuel ESP OFF.") 
            if _G.FuelBill then _G.FuelBill:Destroy() end
        end
   end,
})

-- ==================== 6. AUTO LIGHTS (DELAYED) ====================
local LightsSection = NightTab:CreateSection("Lights")
local RoomLightConnection = nil
NightTab:CreateToggle({
   Name = "Auto Lights",
   CurrentValue = false,
   Flag = "AutoLights",
   Callback = function(enabled)
        if enabled then
            notify("SYSTEM", "Auto Lights ON.") 
            local function activateSwitch(roomName)
                while ActionInProgress do task.wait(0.1) end
                ActionInProgress = true
                local targetVec = RoomCoordinates[roomName]
                if targetVec then
                    local char = player.Character
                    if char and char:FindFirstChild("HumanoidRootPart") then
                        local originalCFrame = char.HumanoidRootPart.CFrame
                        FlightMove(GetGroundedCFrame(targetVec))
                        task.wait(0.5) -- Stabilize
                        local lightsFolder = workspace:FindFirstChild("Lights")
                        if lightsFolder then
                            for _, light in pairs(lightsFolder:GetChildren()) do
                                if light:FindFirstChild("Status") and light.Status:FindFirstChild("RoomName") and light.Status.RoomName.Value == roomName then
                                    local det = light.Switch.Detector
                                    if (det.Position - char.HumanoidRootPart.Position).Magnitude < 15 and det:FindFirstChild("ClickDetector") then
                                        fireclickdetector(det.ClickDetector)
                                        notify("ACTION", "Flashed: " .. roomName)
                                        task.wait(0.8) -- Slow Delay
                                        fireclickdetector(det.ClickDetector)
                                    end
                                end
                            end
                        end
                        task.wait(0.3)
                        FlightMove(originalCFrame)
                    end
                end
                ActionInProgress = false
            end
            
            local function runLightTrap(mutant)
                task.wait(1.5)
                local windows = workspace:FindFirstChild("Windows")
                if windows and mutant:FindFirstChild("HumanoidRootPart") then
                   local mPos = mutant.HumanoidRootPart.Position
                   local closest, dist = nil, 9999
                   for _, w in pairs(windows:GetChildren()) do
                       local p = w.PrimaryPart or w:FindFirstChildWhichIsA("BasePart")
                       if p and (mPos - p.Position).Magnitude < dist then dist = (mPos - p.Position).Magnitude; closest = w end
                   end
                   if closest and closest:FindFirstChild("RoomName") then activateSwitch(closest.RoomName.Value) end
                end
            end
            if workspace:FindFirstChild("Mutant") then task.spawn(function() runLightTrap(workspace.Mutant) end) end
            RoomLightConnection = workspace.ChildAdded:Connect(function(c)
                if c.Name == "Mutant" then task.wait(0.5); if c:FindFirstChild("HumanoidRootPart") then runLightTrap(c) end end
            end)
        else
            notify("SYSTEM", "Auto Lights OFF.") 
            if RoomLightConnection then RoomLightConnection:Disconnect() end
        end
   end,
})
NightTab:CreateParagraph({Title = "Usage", Content = "Scares off Mutant automatically."})

if isBlizzardActive then
    local BlizzardTab = Window:CreateTab("Blizzard", 4483362458)
    local fireConn = nil
    
    local function executeRestock()
        if ActionInProgress or workspace:FindFirstChild("Mutant") then return end
        ActionInProgress = true
        notify("ACTION", "Restocking Fire...")
        
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local startPos = player.Character.HumanoidRootPart.CFrame
            
            -- CHECKPOINT A: Go to Wood
            EnsureSafePosition(GetGroundedCFrame(RoomCoordinates["WoodPile"]), "Fetch Wood")
            
            if woodPile.Detector:FindFirstChild("ClickDetector") then fireclickdetector(woodPile.Detector.ClickDetector) end
            
            -- CHECKPOINT B: Go to Fireplace
            EnsureSafePosition(CFrame.new(RoomCoordinates["FirePlace"]), "Add Wood")
            
            -- CHECKPOINT C: Return Home
            EnsureSafePosition(startPos, "Return Home")
        end
        ActionInProgress = false
    end

    BlizzardTab:CreateToggle({
       Name = "Auto Fireplace",
       CurrentValue = false,
       Flag = "AutoFire",
       Callback = function(on)
            if on then
                notify("SYSTEM", "Auto Fireplace ON.") 
                if fireFuel then fireConn = fireFuel.Changed:Connect(function(val) if val <= 50 then task.spawn(executeRestock) end end) end
            else
                notify("SYSTEM", "Auto Fireplace OFF.") 
                if fireConn then fireConn:Disconnect() end
            end
       end,
    })
    BlizzardTab:CreateButton({Name = "Restock Manually", Callback = function() task.spawn(executeRestock) end})
    BlizzardTab:CreateParagraph({Title = "Usage", Content = "Uses Checkpoints. Hides if Mutant appears."})
end

-- ==================== 7. TOOLS ====================
ToolsTab:CreateButton({
   Name = "Reset Script State (Fix Stuck)",
   Callback = function()
       ActionInProgress = false
       refueling = false
       notify("SYSTEM", "State Reset.")
   end,
})

ToolsTab:CreateButton({
   Name = "Copy Current Position",
   Callback = function()
        local p = game.Players.LocalPlayer
        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local pos = p.Character.HumanoidRootPart.Position
            setclipboard(string.format("Vector3.new(%.3f, %.3f, %.3f)", pos.X, pos.Y, pos.Z))
            notify("OK", "Copied")
        end
   end,
})
