local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Window = Rayfield:CreateWindow({
   Name = "Infiltration Engine | Ultimate",
   LoadingTitle = "Applying Config...",
   LoadingSubtitle = "by Gemini",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "InfiltrationUltimate",
      FileName = "UltimateConfig"
   },
   KeySystem = false,
})

-- ==================== 1. SERVICES & GLOBALS ====================
local player = game.Players.LocalPlayer
local workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

local function notify(title, content)
    Rayfield:Notify({Title = title, Content = content, Duration = 3, Image = 4483362458})
end

local function SafeLoad(parent, name)
    local obj = parent:FindFirstChild(name)
    if not obj then obj = parent:WaitForChild(name, 1) end
    return obj
end

-- CRITICAL OBJECTS
local shack = workspace:WaitForChild("Shack", 5)
local generator = shack and shack:WaitForChild("Generator", 5)
local fuel = generator and generator:WaitForChild("Fuel", 5)
local gameState = ReplicatedStorage:WaitForChild("GameState", 5)

-- MODIFIERS
local mods = {
    Bloodmoon = SafeLoad(gameState, "Bloodmoon"),
    Blizzard = SafeLoad(gameState, "Blizzard"),
    Zombies = SafeLoad(gameState, "Zombies"),
    Thunderstorm = SafeLoad(gameState, "Thunderstorm"),
    Event = SafeLoad(gameState, "Event")
}

local fireFuel = SafeLoad(gameState, "FireFuel")
local woodPile = SafeLoad(workspace, "WoodPile")
local firePlace = SafeLoad(workspace, "FirePlace")

if not shack or not generator or not gameState then 
    notify("WARNING", "Some objects missing.") 
end

-- ==================== 2. TABS ====================
local InfoTab = Window:CreateTab("Info", 4483362458) 
local NightTab = Window:CreateTab("Night 1", 4483362458)   
local ToolsTab = Window:CreateTab("Tools", 4483362458) 

InfoTab:CreateSection("Modifiers")
local function createStatusLabel(name, boolObj)
    local isActive = boolObj and boolObj.Value == true
    local c = isActive and "#00FF00" or "#555555"
    local t = isActive and "ACTIVE" or "INACTIVE"
    InfoTab:CreateParagraph({Title = name, Content = string.format("<font color='%s'>%s</font>", c, t)})
end
createStatusLabel("Bloodmoon", mods.Bloodmoon)
createStatusLabel("Blizzard", mods.Blizzard)
createStatusLabel("Zombies", mods.Zombies)

-- ==================== 3. MOVEMENT LOGIC ====================
local ActionInProgress = false 
local CurrentTween = nil 
local NoclipConnection = nil

local RoomCoordinates = {
    ["Entrance"] = Vector3.new(-4.87, 7.8, -36.31), 
    ["LivingRoom"] = Vector3.new(-22.82, 7.79, -52.76), 
    ["BottomCorridor"] = Vector3.new(-23.02, 7.79, -81.82), 
    ["Ladder"] = Vector3.new(-1.38, 7.79, -61.91), 
    ["TopCorridor"] = Vector3.new(-9.17, 23.79, -74.37), 
    ["Bedroom"] = Vector3.new(-15.19, 23.79, -74.88), 
    ["TopCorridor2"] = Vector3.new(-27.39, 23.79, -41.8), 
    ["Bathroom"] = Vector3.new(-27.76, 23.79, -46.76),
    ["WoodPile"] = Vector3.new(-30.2, 4.2, -114.0),
    ["FirePlace"] = Vector3.new(-44.5, 7.9, -61.9),
    ["JerryCan"] = Vector3.new(-76.875, 4.675, -133.212),
    ["FuseBox"] = Vector3.new(-3.2, 4.7, -93.1)
}

local function GetGroundedCFrame(v) 
    if not player.Character then return CFrame.new(v) end
    return CFrame.new(v) 
end

local function InstantTP(cf)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart
    hrp.Velocity = Vector3.new(0,0,0)
    hrp.AssemblyLinearVelocity = Vector3.new(0,0,0)
    hrp.CFrame = cf
end

local function EnableNoclip(bool)
    if bool then
        if NoclipConnection then NoclipConnection:Disconnect() end
        NoclipConnection = RunService.Stepped:Connect(function()
            if player.Character then
                for _, p in pairs(player.Character:GetDescendants()) do
                    if p:IsA("BasePart") and p.CanCollide then p.CanCollide = false end
                end
            end
        end)
    else
        if NoclipConnection then NoclipConnection:Disconnect(); NoclipConnection = nil end
    end
end

local function FlightMove(targetCFrame)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart
    local tween = TweenService:Create(hrp, TweenInfo.new((hrp.Position - targetCFrame.Position).Magnitude / 55, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
    EnableNoclip(true)
    tween:Play()
    tween.Completed:Wait()
    EnableNoclip(false)
end

local function EmergencyEvac()
    EnableNoclip(false)
    ActionInProgress = false
    notify("DANGER", "Mutant Detected! Evacuating...")
    if player.Character then InstantTP(CFrame.new(RoomCoordinates["BottomCorridor"])) end
end

workspace.ChildAdded:Connect(function(c) if c.Name == "Mutant" and ActionInProgress then EmergencyEvac() end end)

local function SmartWait(dur)
    for i = 1, math.floor(dur / 0.05) do
        if workspace:FindFirstChild("Mutant") then EmergencyEvac(); return false end
        task.wait(0.05)
    end
    return true 
end

-- ==================== 4. REFUEL SYSTEM ====================
local FuelSection = NightTab:CreateSection("Fuel")
local refueling = false
local autoConn = nil

local function executeRefuel(isManual)
    if isManual then ActionInProgress = false; refueling = false end
    if refueling or ActionInProgress then if isManual then notify("BUSY", "Busy.") end; return end
    
    -- [[ SMART WAIT: Wait for Flash/Despawn ]] --
    if not isManual and workspace:FindFirstChild("Mutant") then 
        notify("WAIT", "Mutant nearby! Waiting for flash...")
        repeat task.wait(0.5) until not workspace:FindFirstChild("Mutant")
        notify("CLEAR", "Area safe. Refueling now.")
        -- Logic continues below automatically once loop breaks
    end

    refueling = true; ActionInProgress = true
    
    local s, e = pcall(function()
        local can = shack:FindFirstChild("JerryCan")
        if not can then notify("ERR", "No Can!"); return end
        if player.Character then
            local start = player.Character.HumanoidRootPart.CFrame
            
            -- [[ DOUBLE FILL LOOP ]] --
            for i = 1, 2 do
                notify("ACT", "Refueling ("..i.."/2)...")
                InstantTP(CFrame.new(RoomCoordinates["JerryCan"]))
                if not SmartWait(0.3) then return end
                if can:FindFirstChild("ClickDetector") then fireclickdetector(can.ClickDetector) end
                if not SmartWait(0.5) then return end
                if generator:FindFirstChild("ClickDetector") then 
                    fireclickdetector(generator.ClickDetector)
                    notify("OK", "Filled ("..i..")") 
                end
                if not SmartWait(0.5) then return end
            end
            
            InstantTP(start)
            notify("DONE", "Refuel Complete.")
        end
    end)
    if not s then notify("ERR", "Refuel Crash: "..tostring(e)) end
    refueling = false; ActionInProgress = false
end

NightTab:CreateToggle({Name = "Auto Refuel (40%)", CurrentValue = false, Flag = "AutoRefuel", Callback = function(on)
    if on then 
        notify("SYS", "Auto Refuel ON")
        autoConn = fuel:GetPropertyChangedSignal("Value"):Connect(function() 
            if fuel.Value <= 40 then task.spawn(function() executeRefuel(false) end) end 
        end)
    else 
        if autoConn then autoConn:Disconnect() end 
    end
end})

NightTab:CreateParagraph({Title = "Usage", Content = "Waits for Mutant to be flashed, then fills 2x."})
NightTab:CreateButton({Name = "Refuel Manually", Callback = function() task.spawn(function() executeRefuel(true) end) end})

NightTab:CreateToggle({Name = "Fuel ESP", CurrentValue = false, Flag = "FuelESP", Callback = function(v)
    if v then
        local b = Instance.new("BillboardGui", CoreGui); b.Adornee = generator:FindFirstChildWhichIsA("BasePart"); b.Size = UDim2.new(0,200,0,50); b.AlwaysOnTop = true; b.StudsOffset=Vector3.new(0,4,0)
        local t = Instance.new("TextLabel", b); t.Size = UDim2.new(1,0,1,0); t.BackgroundTransparency = 1; 
        t.TextColor3 = Color3.new(0,1,1); t.Font = Enum.Font.FredokaOne; t.TextSize = 22 -- [[ FONT CHANGED ]] --
        t.Text = "Fuel: "..fuel.Value.."%"; fuel.Changed:Connect(function() t.Text = "Fuel: "..fuel.Value.."%" end); _G.FuelBill = b
    else
        if _G.FuelBill then _G.FuelBill:Destroy() end
    end
end})

-- ==================== 5. LIGHTS SYSTEM ====================
local LightsSection = NightTab:CreateSection("Lights")
local LCon = nil
NightTab:CreateToggle({Name = "Auto Lights", CurrentValue = false, Flag = "AutoLights", Callback = function(on)
    if on then
        notify("SYS", "Auto Lights ON")
        local function trap(m)
            task.wait(1.5)
            local wins = workspace:FindFirstChild("Windows")
            if wins and m:FindFirstChild("HumanoidRootPart") then
                local close, dist = nil, 9999
                for _,w in pairs(wins:GetChildren()) do
                    local p = w.PrimaryPart or w:FindFirstChildWhichIsA("BasePart")
                    if p and (m.HumanoidRootPart.Position - p.Position).Magnitude < dist then dist=(m.HumanoidRootPart.Position-p.Position).Magnitude; close=w end
                end
                if close and close:FindFirstChild("RoomName") then
                    while ActionInProgress do task.wait(0.1) end; ActionInProgress = true
                    local rn = close.RoomName.Value
                    if RoomCoordinates[rn] then
                        local start = player.Character.HumanoidRootPart.CFrame
                        FlightMove(GetGroundedCFrame(RoomCoordinates[rn]))
                        
                        task.wait(0.7) -- [[ 0.7s DELAY ]] --
                        
                        for _,l in pairs(workspace.Lights:GetChildren()) do
                            if l.Status.RoomName.Value == rn then 
                                fireclickdetector(l.Switch.Detector.ClickDetector); notify("ACT", "Flashed "..rn); 
                                task.wait(1); 
                                fireclickdetector(l.Switch.Detector.ClickDetector)
                            end
                        end
                        FlightMove(start)
                    end
                    ActionInProgress = false
                end
            end
        end
        if workspace:FindFirstChild("Mutant") then task.spawn(function() trap(workspace.Mutant) end) end
        LCon = workspace.ChildAdded:Connect(function(c) if c.Name=="Mutant" then task.wait(0.5); trap(c) end end)
    else
        if LCon then LCon:Disconnect() end
    end
end})
NightTab:CreateParagraph({Title = "Usage", Content = "Flashes lights when Mutant peeks (0.7s delay)."})

-- ==================== 6. BLIZZARD SYSTEM ====================
if mods.Blizzard then
    local BzTab = Window:CreateTab("Blizzard", 4483362458); local fCon = nil
    local function executeRestock()
        if ActionInProgress or workspace:FindFirstChild("Mutant") then return end; ActionInProgress = true
        local s, e = pcall(function()
            if player.Character then
                local s = player.Character.HumanoidRootPart.CFrame
                InstantTP(GetGroundedCFrame(RoomCoordinates["WoodPile"])); if not SmartWait(0.3) then return end
                if woodPile.Detector:FindFirstChild("ClickDetector") then fireclickdetector(woodPile.Detector.ClickDetector) end
                if not SmartWait(0.5) then return end
                InstantTP(CFrame.new(RoomCoordinates["FirePlace"])); if not SmartWait(0.4) then return end
                InstantTP(s)
            end
        end)
        ActionInProgress = false
    end
    BzTab:CreateToggle({Name = "Auto Fireplace", Callback = function(on) if on then fCon=fireFuel.Changed:Connect(function(v) if v<=50 then task.spawn(executeRestock) end end) else if fCon then fCon:Disconnect() end end end})
    
    BzTab:CreateToggle({Name = "Fire ESP", Callback = function(v)
        if v then
            local b = Instance.new("BillboardGui", CoreGui); b.Adornee = firePlace; b.Size = UDim2.new(0,200,0,50); b.AlwaysOnTop = true; b.StudsOffset=Vector3.new(0,2,0)
            local t = Instance.new("TextLabel", b); t.Size = UDim2.new(1,0,1,0); t.BackgroundTransparency = 1; 
            t.TextColor3 = Color3.new(1,0.5,0); t.Font = Enum.Font.FredokaOne; t.TextSize = 22 -- [[ FONT CHANGED ]] --
            t.Text = "Fire: "..fireFuel.Value.."%"; fireFuel.Changed:Connect(function() t.Text = "Fire: "..fireFuel.Value.."%" end); _G.FireBill = b
        else
            if _G.FireBill then _G.FireBill:Destroy() end
        end
    end})
    BzTab:CreateButton({Name = "Restock Manually", Callback = function() task.spawn(executeRestock) end})
    BzTab:CreateParagraph({Title = "Usage", Content = "Refuels fire automatically (Instant TP)."})
end

-- ==================== 7. TOOLS ====================
ToolsTab:CreateButton({Name = "Fix Stuck Buttons", Callback = function() ActionInProgress=false; refueling=false; notify("OK", "Reset.") end})
ToolsTab:CreateButton({Name = "Copy Pos", Callback = function() 
    if player.Character then 
        local p = player.Character.HumanoidRootPart.Position
        setclipboard(string.format("Vector3.new(%.3f, %.3f, %.3f)", p.X, p.Y, p.Z))
        notify("OK", "Copied") 
    end 
end})
