local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Window = Rayfield:CreateWindow({
   Name = "Infiltration Engine | Lights Restored",
   LoadingTitle = "Restoring Modules...",
   LoadingSubtitle = "by Gemini",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "InfiltrationUltimate",
      FileName = "UltimateConfig"
   },
   KeySystem = false,
})

-- ==================== 1. SERVICES & GLOBALS ====================
local player = game.Players.LocalPlayer
local workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

local function notify(title, content)
    Rayfield:Notify({Title = title, Content = content, Duration = 3, Image = 4483362458})
end

local function SafeLoad(parent, name)
    local obj = parent:FindFirstChild(name)
    if not obj then obj = parent:WaitForChild(name, 1) end
    return obj
end

-- ==================== 2. CRITICAL OBJECTS ====================
local shack = workspace:WaitForChild("Shack", 5)
local generator = shack and shack:WaitForChild("Generator", 5)
local fuel = generator and generator:WaitForChild("Fuel", 5)
local gameState = ReplicatedStorage:WaitForChild("GameState", 5)

-- MODIFIERS & VALUES
local mods = {
    Bloodmoon = SafeLoad(gameState, "Bloodmoon"),
    Blizzard = SafeLoad(gameState, "Blizzard"),
    Zombies = SafeLoad(gameState, "Zombies"),
    Thunderstorm = SafeLoad(gameState, "Thunderstrom") or SafeLoad(gameState, "Thunderstorm"),
    Event = SafeLoad(gameState, "Event")
}

local fusesFried = SafeLoad(gameState, "FusesFried")
local fireFuel = SafeLoad(gameState, "FireFuel")
local woodPile = SafeLoad(workspace, "WoodPile")
local firePlace = SafeLoad(workspace, "FirePlace")

if not shack or not generator or not gameState then 
    notify("WARNING", "Some game objects are missing.") 
end

-- ==================== 3. MENU TABS ====================
local InfoTab = Window:CreateTab("Info", 4483362458) 
local NightTab = Window:CreateTab("Night 1", 4483362458)   
local ToolsTab = Window:CreateTab("Tools", 4483362458) 

-- INFO TAB LOGIC
InfoTab:CreateSection("Active Modifiers")
local function createStatusLabel(name, boolObj)
    local isActive = boolObj and boolObj.Value == true
    local color = isActive and "#00FF00" or "#555555"
    local statusText = isActive and "ACTIVE!" or "INACTIVE"
    InfoTab:CreateParagraph({Title = name, Content = string.format("<font color='%s'>%s</font>", color, statusText)})
    return isActive
end
createStatusLabel("Bloodmoon", mods.Bloodmoon)
local isBlizzardActive = createStatusLabel("Blizzard", mods.Blizzard)
createStatusLabel("Graves (Zombies)", mods.Zombies)
createStatusLabel("Thunderstorm", mods.Thunderstorm)
createStatusLabel("Party (Event)", mods.Event)

-- ==================== 4. MOVEMENT LOGIC ====================
local ActionInProgress = false 
local CurrentTween = nil 
local NoclipConnection = nil

local RoomCoordinates = {
    ["Entrance"] = Vector3.new(-4.87, 7.8, -36.31), 
    ["LivingRoom"] = Vector3.new(-22.82, 7.79, -52.76), 
    ["BottomCorridor"] = Vector3.new(-23.02, 7.79, -81.82), 
    ["Ladder"] = Vector3.new(-1.38, 7.79, -61.91), 
    ["TopCorridor"] = Vector3.new(-9.17, 23.79, -74.37), 
    ["Bedroom"] = Vector3.new(-15.19, 23.79, -74.88), 
    ["TopCorridor2"] = Vector3.new(-27.39, 23.79, -41.8), 
    ["Bathroom"] = Vector3.new(-27.76, 23.79, -46.76),
    ["WoodPile"] = Vector3.new(-30.2, 4.2, -114.0),
    ["FirePlace"] = Vector3.new(-44.5, 7.9, -61.9),
    ["JerryCan"] = Vector3.new(-76.875, 4.675, -133.212)
}

-- Safe Grounding Helper
local function GetGroundedCFrame(targetVector)
    local char = player.Character
    if not char or not char:FindFirstChild("Humanoid") then return CFrame.new(targetVector) end
    return CFrame.new(targetVector) 
end

-- A. INSTANT TELEPORT (For fast/safe snapping)
local function InstantTP(targetCFrame)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart
    hrp.Velocity = Vector3.new(0,0,0)
    hrp.AssemblyLinearVelocity = Vector3.new(0,0,0)
    hrp.CFrame = targetCFrame
end

-- B. FLIGHT MOVE (For smooth movement through walls)
local function EnableNoclip(bool)
    if bool then
        if NoclipConnection then NoclipConnection:Disconnect() end
        NoclipConnection = RunService.Stepped:Connect(function()
            if player.Character then
                for _, part in pairs(player.Character:GetDescendants()) do
                    if part:IsA("BasePart") and part.CanCollide == true then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        if NoclipConnection then NoclipConnection:Disconnect(); NoclipConnection = nil end
    end
end

local function FlightMove(targetCFrame)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    
    if dist < 5 then
        hrp.CFrame = targetCFrame
    else
        local tweenInfo = TweenInfo.new(dist / 55, Enum.EasingStyle.Linear) 
        CurrentTween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
        EnableNoclip(true)
        CurrentTween:Play()
        CurrentTween.Completed:Wait()
        EnableNoclip(false)
        CurrentTween = nil
    end
end

-- EVACUATION SYSTEM
local function EmergencyEvac()
    if CurrentTween then CurrentTween:Cancel(); CurrentTween = nil end
    EnableNoclip(false)
    notify("DANGER", "Mutant! Evacuating...")
    ActionInProgress = false
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        InstantTP(CFrame.new(RoomCoordinates["BottomCorridor"]))
    end
end

workspace.ChildAdded:Connect(function(child)
    if child.Name == "Mutant" and ActionInProgress then EmergencyEvac() end
end)

-- SMART WAIT (Checks for Mutant while waiting)
local function SmartWait(duration)
    local steps = math.floor(duration / 0.05)
    for i = 1, steps do
        if workspace:FindFirstChild("Mutant") then
            EmergencyEvac()
            return false 
        end
        task.wait(0.05)
    end
    return true 
end

-- ==================== 5. REFUEL SYSTEM ====================
local FuelSection = NightTab:CreateSection("Fuel")
local refueling = false
local autoConn = nil

local function executeRefuel(isManual)
    if isManual then ActionInProgress = false; refueling = false end 

    if refueling or ActionInProgress then 
        if isManual then notify("BUSY", "Script is busy.") end
        return 
    end
    
    if not isManual and workspace:FindFirstChild("Mutant") then notify("WAIT", "Mutant present."); return end

    refueling = true
    ActionInProgress = true
    
    local success, err = pcall(function()
        local can = shack:FindFirstChild("JerryCan")
        if not can then notify("ERROR", "No Jerry Can Found!"); return end
        
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local startPos = player.Character.HumanoidRootPart.CFrame
            notify("ACTION", "Fetching Gas...")
            
            -- 1. Teleport to Can
            InstantTP(CFrame.new(RoomCoordinates["JerryCan"]))
            if not SmartWait(0.3) then return end
            
            -- 2. Pick up Can
            if can:FindFirstChild("ClickDetector") then 
                fireclickdetector(can.ClickDetector) 
            end
            if not SmartWait(0.5) then return end
            
            -- 3. Interact with Generator (While stationary)
            if generator:FindFirstChild("ClickDetector") then
                fireclickdetector(generator.ClickDetector)
                notify("SUCCESS", "Refueled.")
            end
            if not SmartWait(0.5) then return end

            -- 4. Return to Safety
            InstantTP(startPos)
            notify("DONE", "Returned.")
        end
    end)

    if not success then notify("ERROR", "Refuel Error: " .. tostring(err)) end
    refueling = false
    ActionInProgress = false
end

NightTab:CreateToggle({
   Name = "Auto Refuel",
   CurrentValue = false,
   Flag = "AutoRefuel",
   Callback = function(on)
        if on then
            notify("SYSTEM", "Auto Refuel ON.") 
            autoConn = fuel:GetPropertyChangedSignal("Value"):Connect(function()
                if fuel.Value <= 15 then task.spawn(function() executeRefuel(false) end) end
            end)
        else
            notify("SYSTEM", "Auto Refuel OFF.") 
            if autoConn then autoConn:Disconnect() end
        end
   end,
})

NightTab:CreateParagraph({Title = "Usage", Content = "Fetches gas can & fills generator from a distance."})
NightTab:CreateButton({Name = "Refuel Manually", Callback = function() task.spawn(function() executeRefuel(true) end) end})

NightTab:CreateToggle({
   Name = "Fuel ESP",
   CurrentValue = false,
   Flag = "FuelESP",
   Callback = function(v)
        if v then
            notify("SYSTEM", "Fuel ESP ON.") 
            local bill = Instance.new("BillboardGui", CoreGui)
            bill.Adornee = generator:FindFirstChildWhichIsA("BasePart"); bill.Size = UDim2.new(0,260,0,60); bill.StudsOffset = Vector3.new(0,4,0); bill.AlwaysOnTop = true
            local txt = Instance.new("TextLabel", bill); txt.Size = UDim2.new(1,0,1,0); txt.BackgroundTransparency = 1; txt.TextColor3 = Color3.fromRGB(0,255,255); txt.TextStrokeTransparency = 0; txt.Font = Enum.Font.GothamBold; txt.TextSize = 20
            txt.Text = "Fuel: "..fuel.Value.."%"; fuel.Changed:Connect(function() txt.Text = "Fuel: "..fuel.Value.."%" end)
            _G.FuelBill = bill
        else
            notify("SYSTEM", "Fuel ESP OFF.") 
            if _G.FuelBill then _G.FuelBill:Destroy() end
        end
   end,
})
NightTab:CreateParagraph({Title = "Usage", Content = "Shows a text label above the generator with fuel %."})

-- ==================== 6. AUTO LIGHTS (RESTORED & SLOWED) ====================
local LightsSection = NightTab:CreateSection("Lights")
local RoomLightConnection = nil
NightTab:CreateToggle({
   Name = "Auto Lights",
   CurrentValue = false,
   Flag = "AutoLights",
   Callback = function(enabled)
        if enabled then
            notify("SYSTEM", "Auto Lights ON.") 
            local function activateSwitch(roomName)
                while ActionInProgress do task.wait(0.1) end
                ActionInProgress = true
                local targetVec = RoomCoordinates[roomName]
                if targetVec then
                    local char = player.Character
                    if char and char:FindFirstChild("HumanoidRootPart") then
                        local originalCFrame = char.HumanoidRootPart.CFrame
                        -- Use FlightMove for Lights to navigate house
                        FlightMove(GetGroundedCFrame(targetVec))
                        
                        -- WAIT 0.5s BEFORE CLICKING (Stability)
                        task.wait(0.5)
                        
                        local lightsFolder = workspace:FindFirstChild("Lights")
                        if lightsFolder then
                            for _, light in pairs(lightsFolder:GetChildren()) do
                                if light:FindFirstChild("Status") and light.Status:FindFirstChild("RoomName") and light.Status.RoomName.Value == roomName then
                                    local det = light.Switch.Detector
                                    if (det.Position - char.HumanoidRootPart.Position).Magnitude < 15 and det:FindFirstChild("ClickDetector") then
                                        -- CLICK 1
                                        fireclickdetector(det.ClickDetector)
                                        notify("ACTION", "Flashed: " .. roomName)
                                        
                                        -- WAIT 0.8s (User Requested Delay)
                                        task.wait(0.8)
                                        
                                        -- CLICK 2
                                        fireclickdetector(det.ClickDetector)
                                    end
                                end
                            end
                        end
                        
                        -- WAIT 0.3s AFTER CLICKING
                        task.wait(0.3)
                        FlightMove(originalCFrame)
                    end
                end
                ActionInProgress = false
            end
            
            local function runLightTrap(mutant)
                task.wait(1.5)
                local windows = workspace:FindFirstChild("Windows")
                if windows and mutant:FindFirstChild("HumanoidRootPart") then
                   local mPos = mutant.HumanoidRootPart.Position
                   local closest, dist = nil, 9999
                   for _, w in pairs(windows:GetChildren()) do
                       local p = w.PrimaryPart or w:FindFirstChildWhichIsA("BasePart")
                       if p and (mPos - p.Position).Magnitude < dist then dist = (mPos - p.Position).Magnitude; closest = w end
                   end
                   if closest and closest:FindFirstChild("RoomName") then activateSwitch(closest.RoomName.Value) end
                end
            end
            if workspace:FindFirstChild("Mutant") then task.spawn(function() runLightTrap(workspace.Mutant) end) end
            RoomLightConnection = workspace.ChildAdded:Connect(function(c)
                if c.Name == "Mutant" then task.wait(0.5); if c:FindFirstChild("HumanoidRootPart") then runLightTrap(c) end end
            end)
        else
            notify("SYSTEM", "Auto Lights OFF.") 
            if RoomLightConnection then RoomLightConnection:Disconnect() end
        end
   end,
})
NightTab:CreateParagraph({Title = "Usage", Content = "Scares off Mutant when it peeks windows."})

-- ==================== 7. BLIZZARD TAB ====================
if isBlizzardActive then
    local BlizzardTab = Window:CreateTab("Blizzard", 4483362458)
    local fireConn = nil
    
    local function executeRestock()
        if ActionInProgress or workspace:FindFirstChild("Mutant") then return end
        ActionInProgress = true
        notify("ACTION", "Restocking Fire...")
        
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local startPos = player.Character.HumanoidRootPart.CFrame
            
            -- Use InstantTP for Fireplace
            InstantTP(GetGroundedCFrame(RoomCoordinates["WoodPile"]))
            if not SmartWait(0.3) then ActionInProgress=false; return end
            if woodPile.Detector:FindFirstChild("ClickDetector") then fireclickdetector(woodPile.Detector.ClickDetector) end
            if not SmartWait(0.3) then ActionInProgress=false; return end
            InstantTP(CFrame.new(RoomCoordinates["FirePlace"])) 
            if not SmartWait(0.3) then ActionInProgress=false; return end
            InstantTP(startPos)
        end
        ActionInProgress = false
    end

    BlizzardTab:CreateToggle({
       Name = "Auto Fireplace",
       CurrentValue = false,
       Flag = "AutoFire",
       Callback = function(on)
            if on then
                notify("SYSTEM", "Auto Fireplace ON.") 
                if fireFuel then fireConn = fireFuel.Changed:Connect(function(val) if val <= 50 then task.spawn(executeRestock) end end) end
            else
                notify("SYSTEM", "Auto Fireplace OFF.") 
                if fireConn then fireConn:Disconnect() end
            end
       end,
    })
    BlizzardTab:CreateButton({Name = "Restock Manually", Callback = function() task.spawn(executeRestock) end})
    BlizzardTab:CreateParagraph({Title = "Usage", Content = "Refuels fireplace's fire automatically"})
end

-- ==================== 8. TOOLS ====================
ToolsTab:CreateButton({
   Name = "Reset Script State (Fix Stuck)",
   Callback = function()
       ActionInProgress = false
       refueling = false
       notify("SYSTEM", "State Reset.")
   end,
})

ToolsTab:CreateButton({
   Name = "Copy Current Position",
   Callback = function()
        local p = game.Players.LocalPlayer
        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local pos = p.Character.HumanoidRootPart.Position
            setclipboard(string.format("Vector3.new(%.3f, %.3f, %.3f)", pos.X, pos.Y, pos.Z))
            notify("OK", "Copied")
        end
   end,
})
